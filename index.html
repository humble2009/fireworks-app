<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fireworks</title>
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- 手機適配 -->
<style>
    html, body{
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: black;
    }
    canvas{
        display: block;
    }
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d")

function resize(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

const fireworks = [];
const particles = [];

const gravity = 0.08;
const friction = 0.98;

class Firework{
    constructor(x, targetY, color){
        this.x = x;
        this.y = canvas.height;
        this.targetY = targetY;
        this.speed = 7;
        this.exploded = false;
        this.color = color;
    }

    update(){
        this.y -= this.speed;

        if(this.y <= this.targetY){
            this.explode();
            this.exploded = true;
        }
    }

    draw(){
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI*2)
        ctx.fillStyle = this.color;
        ctx.fill();
    }

    explode(){
        const count = 60;
        for(let i =0; i<count; i++){
            particles.push(new Particle(this.x, this.y, this.color));
        }
    }
}

class Particle{
    constructor(x,y, color){
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.pow(Math.random(), 0.5) * 6;

        this.x = x;
        this.y = y;
        this.color = color;

        this.vx = Math.cos(angle) * speed; 
        this.vy = Math.sin(angle) * speed;

        this.life = 1;
        this.size = Math.random() * 5 + 1;
    }
    
    update(){
        this.vx*= friction;
        this.vy*= friction;
        this.vy+= gravity;
        
        this.x += this.vx;
        this.y += this.vy;
        this.life -= 0.02;
    }

    draw(){
        if(this.life <= 0) return; 

        ctx.save();
        ctx.globalAlpha = this.life;

        const gradient = ctx.createRadialGradient(
            this.x, this.y, 0,
            this.x, this.y, 4
        );
        gradient.addColorStop(0, "white");
        gradient.addColorStop(0.3, this.color);
        gradient.addColorStop(1, "transparent");

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }
}

// 手機適配: 計算觸控或滑鼠在 canvas 的座標
function getMousePos(e){
    const rect = canvas.getBoundingClientRect(); // 手機適配
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

canvas.addEventListener("click", e=>{
    const pos = getMousePos(e); // 手機適配
    const margin = 100;
    const targetY = Math.random() * (canvas.height / 4) + margin;
    fireworks.push(new Firework(pos.x, targetY, randomColor())); 
});

// 手機觸控事件
canvas.addEventListener("touchstart", e=>{
    e.preventDefault(); // 手機適配，避免滑動
    const touch = e.touches[0];
    const pos = getMousePos(touch); // 手機適配
    const margin = 150;
    const targetY = Math.random() * (canvas.height / 2) + margin;
    fireworks.push(new Firework(pos.x, targetY, randomColor()));
});

function randomColor(){
    const hue = Math.random() * 360;
    return  `hsl(${hue}, 100%, 60%)`;
}

function animate(){
    ctx.fillStyle = "rgba(0,0,0,0.3)"
    ctx.shadowBlur = 10;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    for(let i = fireworks.length - 1; i >= 0; i--){
        fireworks[i].update();
        fireworks[i].draw();
        if(fireworks[i].exploded) fireworks.splice(i, 1);
    }
    
    for(let i = particles.length - 1; i >= 0; i--){
        particles[i].update();
        particles[i].draw();
        if(particles[i].life <= 0) particles.splice(i, 1);
    }

    requestAnimationFrame(animate);
}

animate();

//service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(() => console.log("Service Worker registered"))
    .catch(err => console.error(err));
}
</script>

</body>
</html>
